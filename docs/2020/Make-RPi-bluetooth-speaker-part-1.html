<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 1) </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2020-05-04 00:00:00 +0200"> <meta property="og:url" content="https://www.nicolabs.net/2020/Make-RPi-bluetooth-speaker-part-1"> <meta property="og:title" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 1) "> <meta property="og:image" content="https://www.nicolabs.net"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="nic0b0"> <meta name="twitter:title" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 1) "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="https://www.nicolabs.net"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 1) "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="https://www.nicolabs.net"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="https://www.nicolabs.net/2020/Make-RPi-bluetooth-speaker-part-1"> <link type="application/atom+xml" rel="alternate" href="https://www.nicolabs.net/feed.xml" title="nicolabs" /> <script type="text/javascript"> var disqus_shortname = 'nicolabs'; </script> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/articles">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Make a Raspberry Pi a Bluetooth speaker (part 1)</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_posts/2020-05-04-Make-RPi-bluetooth-speaker-part-1.md" title="Read full history of this post"> <time class="datePublished" datetime="2020-05-04T00:00:00+02:00" itemprop="datePublished">May 4, 2020</time> <span class="post-meta-separator">‚Ä¢</span> <time class="dateModified" datetime="2023-01-15T00:00:00+01:00" itemprop="dateModified">Updated on Jan 15, 2023</time> </a> <span class="post-meta-separator">‚Ä¢</span> <span itemprop="read_time"> 22 minutes read </span> <span class="post-meta-separator">‚Ä¢</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-good" title="Maturity of this article : draft < good < stable or deprecated">good</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <p><img src="/assets/blog/3rdparty/logos/Bluetooth_FM_Color.png" alt="Bluetooth logo" height="128px" /></p> <p>In this two-part article I describe the steps I had to take to make a <em>headless Raspberry Pi 4</em> a Bluetooth <a href="https://www.howtogeek.com/338750/whats-the-difference-between-bluetooth-a2dp-and-aptx/">A2DP</a> speaker.</p> <p>My goal was to offer a user-friendly way for anyone in the same room to <strong>pair its Bluetooth smartphone with the Raspberry Pi and play music through it</strong>, while making sure the <strong>neighbors won‚Äôt be able to connect without approval</strong>.</p> <p>To output music, you can <strong>connect a Hi-Fi system to the Raspberry Pi</strong> using the Jack plug or an audio add-on card : this part depends on your setup.</p> <p><img class="plantuml" id="6db81ae42560b1e3a86d8afb5320a86d" alt="PlantUML diagram" src="/assets/uml/6db81ae42560b1e3a86d8afb5320a86d.svg" /></p> <p>Allright, let‚Äôs dive into how Bluetooth works.</p> <blockquote> <p><em>This is a two-part article :</em></p> <ol> <li><em>How Bluetooth pairing works (this part)</em></li> <li><em>Raspberry Pi as a Bluetooth A2DP receiver (soon available)</em></li> </ol> </blockquote> <h2 id="how-bluetooth-pairing-works">How Bluetooth pairing works</h2> <p>Bluetooth is quite a complex thing. Really. I haven‚Äôt realized before I started this mini project. Beside its original goal to be a wireless replacement for cables, Bluetooth actually includes <a href="https://en.wikipedia.org/wiki/Bluetooth#List_of_applications">a myriad of features</a>.</p> <p>In order to understand how we should connect to our Raspberry Pi (<em>RPi</em>), let‚Äôs focus on some core aspects of Bluetooth.</p> <h3 id="bluetooth-security-models">Bluetooth security models</h3> <p>Being tightly coupled with hardware, Bluetooth has evolved a lot since its beginnings, following industry‚Äôs technical enhancements over the years. This is why it has so many <em>security models</em> ; let‚Äôs try to understand how they compare.</p> <h4 id="there-are-two-distinct-branches-in-bluetooth">There are two distinct ‚Äúbranches‚Äù in Bluetooth.</h4> <p>The legacy Bluetooth branch, <strong>‚ÄúBasic Rate‚Äù (BR)</strong> was the first and only protocol in the beginning. It was quickly complemented with <em>EDR (Enhanced Data Rate)</em> in Bluetooth 2.0, hence the name <strong>BR/EDR</strong>.</p> <p>Bluetooth 4.0 introduced another, not backward-compatible protocol : <strong>‚ÄúBluetooth Low Energy‚Äù (abbreviated LE, or BLE)</strong>. This new Bluetooth ‚Äúbranch‚Äù requires less energy and fits smartphones and <em>IoT</em> better.</p> <p>Althought <em>BR/EDR</em> and <em>BLE</em> are not compatible with each other, Bluetooth devices can actually implement both.</p> <p>For the record there is also an additional ‚ÄúAMP‚Äù specification to achieve Wi-Fi class transfer rates, usually implemented by a secondary electronic chip.</p> <p>Each branch has its own security and association models, even though they all follow the same logic :</p> <p><img class="plantuml" id="066cc5d2b2fa5d69148f35ff812fb260" alt="PlantUML diagram" src="/assets/uml/066cc5d2b2fa5d69148f35ff812fb260.svg" /></p> <h4 id="which-security-level-to-choose-">Which security level to choose ?</h4> <p>The Bluetooth Core Specification<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> makes it clear that :</p> <blockquote> <p>Secure Connections Only Mode is sometimes called a ‚ÄúFIPS Mode‚Äù. This mode should be used when it is more important for a device to have high security than it is for it to maintain backwards compatibility with devices that do not support Secure Connections.</p> </blockquote> <p>My feeling reading the specifications is that Bluetooth was not made with high expectations on security from the beginning. It has so many trade-offs at the benefit of usability that <em>Secure Connections</em>, whether for BR/EDR or LE, just looks to me like the bare minimum to have.</p> <p><em>BR/EDR Legacy Pairing</em>‚Äôs security for instance <em>unavoidably depends</em> on the length of the PIN (which is often a small four-digit number, or even a fixed value) and provide little-to-none protection against <a href="https://en.wikipedia.org/wiki/Eavesdropping">eavesdropping</a> or <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle (MITM) attacks</a>. <em>Secure Simple Pairing</em> for its part only <em>‚Äúprotects the user from MITM attacks with a goal of offering a 1 in 1,000,000 chance that a MITM could mount a successful attack<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>‚Äú</em>. <strong>It strongly relies on human decision (based on warning messages in case of an attack) to mitigate risks and allows for configurations that <em>can</em> make it unsecure</strong>. In short, it‚Äôs easy to configure it wrong and let the neighbors accidentally connect to your Bluetooth device and maybe gather personal informations.</p> <p>Also, ‚ÄúLE is the new BR/EDR‚Äù. Indeed, most efforts seem to be put on Bluetooth LE as Bluetooh BR/EDR lacks behind, not keeping up with today‚Äôs requirements. For instance : with BR/EDR, cryptographic key generation is being made in lower, often hardware, layers, making it difficult to upgrade security algorithms. <strong>This leaves us with a plethora of insecure devices in the wild.</strong></p> <p><strong>üëâ Wrapping up, this gives the ‚ÄúLE Secure Connections‚Äù mode my preference.</strong></p> <h3 id="bluetooth-association-models">Bluetooth association models</h3> <p>As advertised in the above diagram, each security model allows a number of <em>association models</em>. There are four of them available since <em>Secure Simple Pairing</em> :</p> <ul> <li><strong>Numeric Comparison</strong> (since Bluetooth 4.2 for BLE)</li> <li><strong>Just Works</strong></li> <li><strong>Passkey entry</strong></li> <li><strong>Out-of-Band (OOB)</strong></li> </ul> <p>For the sake of completeness we will also talk about <strong>BR/EDR Legacy pairing</strong>.</p> <p>Let‚Äôs see how they work, and how well they would fit our use case.</p> <h4 id="numeric-comparison">Numeric comparison</h4> <p>The Bluetooth Core Specification<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> has a very neat way to describe the <em>Numeric Comparison</em> model :</p> <blockquote> <p>The user is shown a six digit number (from ‚Äú000000‚Äù to ‚Äú999999‚Äù) on both displays and then asked whether the numbers are the same on both devices. If ‚Äúyes‚Äù is entered on both devices, the pairing is successful.</p> </blockquote> <p>It is important to understand that <em>this number is not chosen</em> by any party : it is randomly computed on each connection attempt, as part of the pairing algorithm<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>. <em>It is not a passcode</em> either : it just helps users check that they pair to the expected device by showing the same value on both sides. A malicious user trying to penetrate our home would just have to initiate pairing, hit ‚ÄúYes‚Äù on its side and hope we would do the same, not really looking at the number.</p> <p>The <em>Numeric Comparison</em> protocol also allows devices to skip user confirmation<sup id="fnref:4:1" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>, implementing automatic pairing. In this case anyone within reach of such a device can connect. End.</p> <p>As we‚Äôll see later, you may not have a choice and be forced into a model due to devices limitations. In our case we will need to make sure the Raspberry Pi will not offer this kind of bypass.</p> <h4 id="just-works">Just works</h4> <p>The <em>Just Works</em> model is a specific case of <em>Numeric Comparison</em> designed for the case where at least one device in the pair has no human interface at all. Therefore, it does not enforce any confirmation whatsoever.</p> <p>Here is an excerpt from the specifications<sup id="fnref:3:1" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> :</p> <blockquote> <p>The Just Works association model uses the Numeric Comparison protocol but the user is never shown a number and the application may simply ask the user to accept the connection (exact implementation is up to the end product manufacturer).</p> </blockquote> <p>As for <em>Numeric Comparison</em>, it may still be a good candidate for our use case, provided that we add a mandatory confirmation step, as allowed.</p> <h4 id="passkey-entry">Passkey Entry</h4> <p><em>Passkey Entry</em> is used when one of the devices has input capabilities but no display (e.g. a keyboard).</p> <p>A six-digit number is displayed on the device that can display and must be entered on the other one for the pairing to be successful.</p> <p>At the difference of <em>Numeric Comparison</em>, this number is not only here to check that the devices are the ones we intend to pair, but it also serves as an input data <em>required</em> to authenticate and validate the association<sup id="fnref:4:2" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>.</p> <p>In contrast with <em>Numeric Comparison</em>, this model does not allow automatic connection because each side has to prove they know the <em>passkey</em> :</p> <ul> <li>the <em>display device</em> is the only one to know the number in the beginning ; it decides the way the <em>passkey</em> is revealed to the other one</li> <li>the <em>input-only device</em> must enter the (supposedly secret) <em>passkey</em></li> </ul> <p>In the case of a headless Raspberry Pi :</p> <ul> <li>if it were the <em>display device</em>, we could plug a mini display on it, or make it <em>speak</em> the code through the Hi-Fi system, to provide it to the user</li> <li>if it were the <em>input-only device</em>, we should find a way to get the number displayed on the other device entered into the RPi (maybe letting the user type it)</li> </ul> <p>This may not look trivial ; we‚Äôll see what can be done later on‚Ä¶</p> <h4 id="out-of-band-oob">Out of Band (OOB)</h4> <p>With <a href="https://www.bluetooth.com/blog/bluetooth-pairing-part-5-legacy-pairing-out-of-band/">Out of Band</a>, the devices first discover (and optionally authenticate) themselves with a different mechanism than Bluetooth. It can be any protocol, like NFC or Wi-Fi for instance.</p> <p>This fits well when both devices are known to share a common mechanism and are explicitly set up to work in this way. For instance a camera and its manufacturer‚Äôs mobile application will both be programmed to connect with NFC first, then share their ‚Äúservices‚Äù through Bluetooth.</p> <p>But this does not fit our use case, as we want to allow most smartphones - with only standard applications - to connect. Furthermore, we want to leverage on existing Bluetooth capabilites, not invent new ones‚Ä¶</p> <h4 id="bredr-models">BR/EDR models</h4> <p>The four previous models also apply to the BR/EDR side, with some subtle differences in their implementation (not covered here)‚Ä¶</p> <p>The last model, <strong>BR/EDR Legacy pairing</strong>, only applies to BR/EDR. It is outdated but was the only association model before Bluetooth 2.1 and therefore is very probably still there because of older devices.</p> <p>It requires the two devices to enter the same, 16-character maximum, secret PIN code.</p> <p>Although it looks similar to <em>Passkey Entry</em>, it is far less secure because, here, the connection‚Äôs encryption directly depends on the complexity of the PIN. <a href="https://thesecurityfactory.be/password-cracking-speed/">Nowadays, passwords less than 7 characters (including special ones) can be cracked instantly, it requires a maximum of 4 hours and 100$ for a 16-<em>digit</em> PIN</a>‚Ä¶</p> <p>What sounds like a practical idea to implement on headless devices with a static PIN, unfortunately reveals to be largely insecure. The underlying cryptography is just not strong enough to compensate weak PIN codes that have been hardcoded on existing devices‚Ä¶</p> <p>It is therefore not considered a potential solution in this article.</p> <h3 id="choosing-the-right-association-model">Choosing the right association model</h3> <p>I‚Äôve chosen the three following factors to compare BLE association models regarding my use case :</p> <ol> <li>User authentication but with simple interaction (e.g. no SSH login to type a passkey)</li> <li>Must be able to control who can connect to the Raspberry Pi (i.e. only known device or manually approved ones)</li> <li>Secure enough (as much as Bluetooth can)</li> </ol> <p>Let‚Äôs summarize what we‚Äôve asserted in the previous chapter :</p> <table> <thead> <tr> <th>¬†</th> <th>Numeric comparison*</th> <th>Just Works</th> <th>Passkey Entry</th> <th>Out of Band</th> <th>BR/EDR Legacy Pairing</th> </tr> </thead> <tbody> <tr> <td>User interaction needed</td> <td>yes ‚úÖ</td> <td>no ‚ùå</td> <td>yes ‚úÖ</td> <td>possible ‚úÖ</td> <td>yes ‚úÖ</td> </tr> <tr> <td>Control who can connect</td> <td>no ‚ùå<br />(random number)</td> <td>no ‚ùå</td> <td>yes ‚úÖ<br />(shared passkey)</td> <td>possible ‚úÖ</td> <td>yes ‚úÖ</td> </tr> <tr> <td>Secure-enough protocol</td> <td>yes ‚úÖ</td> <td>yes ‚úÖ</td> <td>yes ‚úÖ</td> <td>yes** ‚úÖ</td> <td>no ‚ùå</td> </tr> </tbody> </table> <p><em>* without automatic pairing</em> <em>** possibly more than others<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup></em></p> <p>This tables depicts the fact that the only way to <em>control who can connect</em> is by requiring the user to enter some - not random - key. Cells indicating ‚Äúno user interaction‚Äù imply that there is no approval.</p> <p>As discussed before, <em>Out of Band</em> is eliminated because it requires an additional protocol and <em>BR/EDR Legacy Pairing</em> is irrelevant for security reasons.</p> <p>üëâ In order to get all our three requirements statisfied we may therefore use :</p> <ul> <li><strong>Numeric Comparison, but with a custom headless validation step</strong></li> <li><strong>Just Works, but with additional custom authorization</strong></li> <li><strong>Passkey Entry</strong> by implementing a headless mechanism to display and validate a 6-digit number</li> </ul> <p>Unfortunately, except for <em>BR/EDR Legacy Pairing</em> <strong>one cannot directly <em>choose</em> the association model : it is automatically asserted from the devices‚Äô <a href="https://www.bluetooth.com/blog/bluetooth-pairing-part-1-pairing-feature-exchange/"><em>Input and Output capabilities (IO capabilities)</em></a><sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup></strong>.</p> <p>In order to make sure only approved workflows can be used, our RPi device must therefore advertise only the corresponding IO capabilites.</p> <p>How ? There are full-blown tables<sup id="fnref:3:2" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> mapping the available IO capabilities to the matching association models.</p> <p>The <strong>input capabilites</strong> are :</p> <ul> <li><strong>No input</strong> : Device does not have the ability to indicate ‚Äòyes‚Äô or ‚Äòno‚Äô</li> <li><strong>Yes / No</strong> : Device provides the user a way to indicate either ‚Äòyes‚Äô or ‚Äòno‚Äô</li> <li><strong>Keyboard</strong> : Device allows the user to input numbers <em>and</em> to indicate ‚Äòyes‚Äô or ‚Äòno‚Äô</li> </ul> <p>And the <strong>output capabilities</strong> are :</p> <ul> <li><strong>No output</strong> : Device does not have the ability to display or communicate a 6 digit decimal number</li> <li><strong>Numeric output</strong> : Device has the ability to display or communicate a 6 digit decimal number</li> </ul> <p>Here is an overview of the <strong>IO capabilities mapping to the matching association models</strong> :</p> <table> <caption>Mapping of IO capabilities to key generation method (simplified)</caption> <colgroup> <col class="col-header" /> <col class="col-header" /> </colgroup> <tr> <td colspan="2" class="empty" /> <th colspan="5">Device A (Initiator)</th> </tr> <tr> <td colspan="2" class="empty" /> <th> Display Only <br /><span class="small"> (No input + Numeric output) </span></th> <th class="cell-selected"> Display YesNo <br /><span class="small"> (Yes/No + Numeric output) </span></th> <th> Keyboard Only <br /><span class="small"> (Keyboard + No output) </span></th> <th class="cell-noinputnooutput"> NoInput NoOutput <br /><span class="small"> (No input or Yes/No + No output) </span></th> <th class="cell-selected"> Keyboard Display <br /><span class="small"> (Keyboard + Numeric output) </span></th> </tr> <!-- Row for DisplayOnly --> <tr> <th class="vertical" rowspan="5"><span>Device B (Responder)</span></th> <th class="vertical"><span>Display Only</span></th> <td>Just Works</td> <td class="cell-selected">Just Works</td> <td>Passkey Entry : responder displays, initiator inputs</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected">Passkey Entry : responder displays, initiator inputs</td> </tr> <!-- Row for DisplayYesNo --> <tr> <th class="vertical"><span>Display YesNo</span></th> <td>Just Works</td> <td class="cell-selected">Numeric Comparison</td> <td>Passkey Entry : responder displays, initiator inputs</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected">Numeric Comparison</td> </tr> <!-- Row for KeyboardOnly --> <tr> <th class="vertical"><span>Keyboard Only</span></th> <td>Passkey Entry: initiator displays, responder inputs</td> <td class="cell-selected">Passkey Entry: initiator displays, responder inputs</td> <td>Passkey Entry: both input</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected">Passkey Entry: initiator displays, responder inputs</td> </tr> <!-- Row for NoInputNoOutput --> <tr> <th class="vertical"><span>NoInput NoOutput</span></th> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected cell-noinputnooutput">Just Works</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected cell-noinputnooutput">Just Works</td> </tr> <!-- Row for KeyboardDisplay --> <tr> <th class="vertical"><span>Keyboard Display</span></th> <td>Passkey Entry: initiator displays, responder inputs</td> <td class="cell-selected">Numeric Comparison</td> <td>Passkey Entry: responder displays, initiator inputs</td> <td class="cell-noinputnooutput">Just Works</td> <td class="cell-selected">Numeric Comparison</td> </tr> </table> <p><em>Source : Mapping of IO capabilities to key generation method<sup id="fnref:7:1" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup> (without OOB nor LE Legacy Pairing)</em></p> <p>Assuming smartphones would advertise themselves either as <em>DisplayYesNo</em> or <em>KeyboardDisplay</em> (highlighted cells), the above matrix shows that we should prepare to connect using any association model of ‚ÄúNumeric Comparison‚Äù, ‚ÄúJust works‚Äù or ‚ÄúPasskey entry‚Äù.</p> <p>Additionally, this table emphasizes that <strong>a device may enforce the <em>Just Works</em> model</strong> simply by advertising itself as <em>NoInputNoOutput</em>. Although this makes it easier for the Industry to build devices with limited or no interface, this is also a leverage for pirates ‚ò† to force our system into a lower security.</p> <p>We have the possibility to deny any pairing in the <em>Just Works</em> workflow, but this may prevent some genuine devices to connect : we should rather enforce a validation step. The main difference between ‚ÄúJust Works + validation‚Äù and other workflows would be the use of a custom authentication mechanism instead of a six-digit number verification.</p> <h3 id="putting-it-altogether-with-bluez">Putting it altogether with BlueZ</h3> <p>Now that we know <em>what</em> we should do in our solution, let‚Äôs have an overiew of <em>how</em> to implement it.</p> <p>Linux systems (which we will use for our Raspberry Pi) have a complex Bluetooth stack, but we will only need to focus on the following parts :</p> <ul> <li>the <a href="http://www.bluez.org/">BlueZ</a> system daemon will handle core Bluetooth features</li> <li>modules will allow us to connect with specialized services : ALSA/PulseAudio in our case in order to receive and play sound from paired devices</li> <li>a registration <strong>agent</strong> will handle the pairing part as we like <strong>=&gt; this is where we will put any custom authorization step</strong></li> </ul> <p>Having the Bluez daemon and the audio modules work together is only a matter of configuration (which is already not trivial).</p> <p>However I could not find a bluetooth agent matching my use case :</p> <ul> <li>the default agent <a href="https://unix.stackexchange.com/questions/352494/alternative-to-the-now-deprecated-rfcomm-binary-in-bluez#463502"><code class="language-plaintext highlighter-rouge">bt-agent</code> has been deprecated</a></li> <li>the <code class="language-plaintext highlighter-rouge">bluetoothctl</code> command cannot easily be used in scripts</li> <li>the quite common <code class="language-plaintext highlighter-rouge">simple-agent</code> sample script does not implement the right features‚Ä¶</li> </ul> <h4 id="conclusion">Conclusion</h4> <p>Bluetooth does not provide a secure and automatic way to pair with headless devices out of the box.</p> <p>The existence of several association models with complex selection rules make it easy to get it wrong.</p> <p>We will use the <em>bluez</em> Linux stack to implement the basis of our solution and will need to create a custom agent to add secure-enough authorization to the existing pairing workflows.</p> <p><strong>Part 1 is over, let‚Äôs see how to set up the whole thing in part 2 : ‚ÄúRaspberry Pi as a Bluetooth A2DP receiver‚Äù (soon available).</strong></p> <h2 id="references">References</h2> <ul> <li>Top illustration : <a href="https://commons.wikimedia.org/wiki/File:Bluetooth_FM_Color.png">Bluetooth.svg by Skarr21</a> / <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA</a></li> <li><a href="https://www.bluetooth.com/blog/bluetooth-pairing-part-1-pairing-feature-exchange/">Bluetooth Pairing Part 1 ‚Äì Pairing Feature Exchange</a></li> <li><a href="https://www.bluetooth.com/blog/bluetooth-pairing-part-2-key-generation-methods/">Bluetooth Pairing Part 2 Key Generation Methods</a></li> <li><a href="https://www.bluetooth.com/blog/bluetooth-pairing-passkey-entry/?utm_campaign=developer&amp;utm_source=internal&amp;utm_medium=blog&amp;utm_content=bluetooth-pairing-part-4-LE-secure-connections-numeric-comparison">Bluetooth Pairing Part 3 ‚Äì Low Energy Legacy Pairing Passkey Entry</a></li> <li><a href="https://www.bluetooth.com/blog/bluetooth-pairing-part-4/?utm_campaign=developer&amp;utm_source=internal&amp;utm_medium=blog&amp;utm_content=bluetooth-pairing-part-3-low-energy-legacy-pairing-passkey-entry">Bluetooth Pairing Part 4: Bluetooth Low Energy Secure Connections ‚Äì Numeric Comparison</a></li> <li><a href="https://www.bluetooth.com/specifications/bluetooth-core-specification/">Bluetooth Core Specification v5.2</a></li> <li><a href="https://en.wikipedia.org/wiki/Bluetooth#Pairing_and_bonding">en.wikipedia.org/wiki/Bluetooth</a>, 2020-04-10</li> </ul> <h3 id="bluetooth-core-specification-inline-references">Bluetooth Core specification inline references</h3> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>Bluetooth Core specification Vol 1, Part A, ¬ß5.3 ‚ÄúSECURE CONNECTIONS ONLY MODE‚Äù¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>Bluetooth Core specification Vol 1, Part A, ¬ß5.2 ‚ÄúBR/EDR SECURE SIMPLE PAIRING‚Äù¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:3" role="doc-endnote"> <p>Bluetooth Core specification Vol 3, Part C, ¬ß5.2.2.4 ‚ÄúIO capabilities‚Äù¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a>¬†<a href="#fnref:3:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>¬†<a href="#fnref:3:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p> </li> <li id="fn:4" role="doc-endnote"> <p>Bluetooth Core specification Vol 2, Part F, ¬ß4.2 ‚ÄúSIMPLE PAIRING MESSAGE SEQUENCE CHARTS‚Äù¬†<a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a>¬†<a href="#fnref:4:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>¬†<a href="#fnref:4:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p> </li> <li id="fn:5" role="doc-endnote"> <p>Bluetooth Core specification Vol 2, Part H, ¬ß7.2.3 ‚ÄúAuthentication stage 1: Passkey Entry protocol‚Äù¬†<a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:6" role="doc-endnote"> <p>Bluetooth Core specification Vol 3, Part H, ¬ß2.3.5.4 ‚ÄúOut of band‚Äù¬†<a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:7" role="doc-endnote"> <p>Bluetooth Core specification Vol 3, Part H, ¬ß2.3.2 ‚ÄúIO capabilities‚Äù¬†<a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a>¬†<a href="#fnref:7:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> </ol> </div> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#raspberry-pi">#raspberry pi</a></li> <li class="tag"><a href="/tags#bluetooth">#bluetooth</a></li> <li class="tag"><a href="/tags#series-make-a-raspberry-pi-a-bluetooth-speaker">#Series : Make a Raspberry Pi a Bluetooth speaker</a></li> </ul> </aside> <aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=Make a Raspberry Pi a Bluetooth speaker (part 1)&amp;url=https://www.nicolabs.net/2020/Make-RPi-bluetooth-speaker-part-1&amp;hashtags=web,dev,blog,soudev&amp;via=nic0b0" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.nicolabs.net/2020/Make-RPi-bluetooth-speaker-part-1" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside> </div> </article> <footer class="site-footer"> <div class="container"> <small class="pull-left">&copy;2023 All rights reserved. Graphic banner from https://showyourstripes.info</small> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
