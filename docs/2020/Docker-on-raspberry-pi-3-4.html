<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> nicolabs | Docker on Raspberry Pi 3 &amp; 4 </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2020-03-26 00:00:00 +0100"> <meta property="og:url" content="https://www.nicolabs.net/2020/Docker-on-raspberry-pi-3-4"> <meta property="og:title" content=" nicolabs | Docker on Raspberry Pi 3 &amp; 4 "> <meta property="og:image" content="https://www.nicolabs.net"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="nic0b0"> <meta name="twitter:title" content=" nicolabs | Docker on Raspberry Pi 3 &amp; 4 "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="https://www.nicolabs.net"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | Docker on Raspberry Pi 3 &amp; 4 "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="https://www.nicolabs.net"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="https://www.nicolabs.net/2020/Docker-on-raspberry-pi-3-4"> <link type="application/atom+xml" rel="alternate" href="https://www.nicolabs.net/feed.xml" title="nicolabs" /> <script type="text/javascript"> var disqus_shortname = 'nicolabs'; </script> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/tags">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Docker on Raspberry Pi 3 & 4</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_preposts/2020-03-26-Docker-on-raspberry-pi-3-4.md" title="Read full history of this post"> <time class="datePublished" datetime="2020-03-26T00:00:00+01:00" itemprop="datePublished">Mar 26, 2020</time> </a> <span class="post-meta-separator">•</span> <span itemprop="read_time"> 5 minutes read </span> <span class="post-meta-separator">•</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-draft" title="Maturity of this article : draft < good < stable or deprecated">draft</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <h2 id="why-docker-is-not-working-out-of-the-box-on-raspberry-pi-3--4">Why Docker is not working out-of-the-box on Raspberry Pi 3 &amp; 4</h2> <p>Docker is a virtualization technology, made to allow applications to be independent from the underlying system. However because it is not a full-fledge virtual machine but rather a proxy to system resources leveraging on Linux kernel’s virtualization features, it does not provide a total independance from the system’s CPU architecture.</p> <p>This is a problem with Raspberry Pi because most of the Docker images around are built for <em>amd64</em> architectures (x86 64 bits) and therefore will not run as-is on a RPi, which is <em>armhf</em>.</p> <p>There are some registries providing Raspberry Pi Docker images (e.g. <a href="https://www.linuxserver.io/">linuxserver.io</a>) but there are not plenty. For instance, you will not find an XMPP server (<em>ejabberd</em> or <em>Prosody</em>) image on <em>linuxserver.io</em>.</p> <p>For instance, <a href="https://github.com/open-eats/OpenEats/blob/master/docs/Running_the_App.md">try to run OpenEats</a> (which provides a user-friendly script that pulls then runs a few docker images using <em>docker-compose</em>), on a Raspberry Pi :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pulling db (mariadb:5.5.64)...
5.5.64: Pulling from library/mariadb
ERROR: no matching manifest for linux/arm/v7 in the manifest list entries
</code></pre></div></div> <p>And when you managed to run it by replacing the <em>mariadb</em> image with <em>linuxserver/mariabdb</em> :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>standard_init_linux.go:211: exec user process caused "exec format error"
</code></pre></div></div> <p>Very frustrating…</p> <p>https://hub.docker.com/u/balenalib/ : images balena.io (ex resin.io), surtout des images de base ?</p> <h2 id="raspberry-pi-3--4-cpu-architecture">Raspberry Pi 3 &amp; 4 CPU architecture</h2> <p>Raspberry Pi 3 and <a href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/specifications/">4 have a 64 bits CPU (ARM v8)</a> <strong>but</strong> there is no official OS with 64 bits support.</p> <p>For instance the default <em>Raspbian</em> flavor is based on Debian <em>armhf</em>, which has a 32 bits kernel enhanced with Hardware Floating point (‘hf’ in ‘armhf’) support. When running <code class="language-plaintext highlighter-rouge">cat /proc/cpuinfo</code> on a RPi 4 you get <code class="language-plaintext highlighter-rouge">armv71</code> and <code class="language-plaintext highlighter-rouge">BCM2835</code>, where you should get <code class="language-plaintext highlighter-rouge">armv8</code> and <code class="language-plaintext highlighter-rouge">BCM2711</code>, according to the specs. Therefore I assume this is because the <em>BMC2835</em> driver is used, with <em>armhf</em> kernel supporting only for <em>armv71</em>.</p> <p>Fortunately it seems that recent versions can be tweaked to enable 64 bits support :</p> <p>https://github.com/raspberrypi/firmware/issues/550#issuecomment-536453126 :</p> <blockquote> <p>Recent kernel releases include a trial 64-bit build. It hasn’t made its way into the Raspbian kernel package yet, but you can install using <code class="language-plaintext highlighter-rouge">sudo rpi-update</code>. You will need to add <code class="language-plaintext highlighter-rouge">arm_64bit=1</code> to config.txt because the firmware prefers the 32-bit build.</p> <p>A 64-bit userland is not currently planned.</p> </blockquote> <p>Questions :</p> <ul> <li>what is the level of compatibility of this 64 bits flavor ?</li> <li>would the effort to get a full 64 bits OS be worth it on the RPi ?</li> </ul> <h2 id="so-what-">So what ?</h2> <p>There are two alternatives I can think of :</p> <ol> <li> <p>Only run 32 bits images. As I understand this means running <strong>armhf</strong>/<a href="https://hub.docker.com/u/arm32v7/">arm32v7</a> images : this does not solve my problem because those images are not widely seen on the net. I would have to build my own images, which sometimes can become cumbersome because of build dependencies not compiled for the host OS (Raspbian).</p> </li> <li> <p>Use a 64 bits OS. This is risky as it may not be stable and many applications / libraries may not work yet. Docker would probably work since it mainly needs the kernel but that might mean running applications only as Docker containers, which is sometimes a lot of work…</p> </li> </ol> <h2 id="multi-arch-images">Multi-arch images</h2> <p>It is possible to build images for several architectures with <em>Docker Desktop</em>, which is bundled with OS-dependent hypervisors and LinuxKit, which can run binaries of any supported architectures.</p> <p>Unfortunately, <em>Docker Desktop</em> is only available for Mac OS and Windows, not for Ubuntu… But <a href="https://github.com/docker/buildx">it can be enabled</a> :</p> <blockquote> <p>buildx comes bundled with Docker CE starting with 19.03, but requires experimental mode to be enabled on the Docker CLI. To enable it, “experimental”: “enabled” can be added to the CLI configuration file ~/.docker/config.json. An alternative is to set the DOCKER_CLI_EXPERIMENTAL=enabled environment variable.</p> </blockquote> <h2 id="references">References</h2> <ul> <li><a href="https://stackoverflow.com/questions/37790029/what-is-difference-between-arm64-and-armhf">What is difference between arm64 and armhf? @ stackoverflow</a></li> <li><a href="https://github.com/raspberrypi/firmware/issues/550">AArch64 support #550 @ github.com/raspberrypi/firmware</a></li> <li><a href="https://www.techiebouncer.com/2019/08/operating-system-for-raspberry-pi-4.html">Operating System for Raspberry pi 4 (32/64 bit)</a></li> <li><a href="https://raspberrypi.stackexchange.com/questions/100926/64-bit-os-on-raspberry-pi-4">64-bit OS on Raspberry Pi 4</a></li> <li><a href="https://docker.com/blog/multi-arch-images"></a></li> </ul> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#docker">#docker</a></li> <li class="tag"><a href="/tags#raspberry-pi">#raspberry pi</a></li> </ul> </aside> <aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=Docker on Raspberry Pi 3 & 4&amp;url=https://www.nicolabs.net/2020/Docker-on-raspberry-pi-3-4&amp;hashtags=web,dev,blog,soudev&amp;via=nic0b0" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.nicolabs.net/2020/Docker-on-raspberry-pi-3-4" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside> </div> </article> <footer class="site-footer"> <div class="container"> <small class="pull-left">&copy;2022 All rights reserved.</small> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
