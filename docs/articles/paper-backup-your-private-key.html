<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="shortcut icon" type="image/png" href="/assets/about/favicon.ico"> <title> nicolabs | A paper backup for your private key </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2012-06-14 01:03:28 +0200"> <meta property="og:url" content="https://www.nicolabs.net/articles/paper-backup-your-private-key"> <meta property="og:title" content=" nicolabs | A paper backup for your private key "> <meta property="og:image" content="https://www.nicolabs.net"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" nicolabs | A paper backup for your private key "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="https://www.nicolabs.net"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | A paper backup for your private key "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="https://www.nicolabs.net"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="https://www.nicolabs.net/articles/paper-backup-your-private-key"> <link type="application/atom+xml" rel="alternate" href="https://www.nicolabs.net/feed.xml" title="nicolabs" /> <script type="text/javascript" src="/assets/lib/cactus.js"></script> <link rel="stylesheet" href="/assets/css/cactus.css" type="text/css"> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/articles">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">A paper backup for your private key</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_posts/2012-06-14-A-paper-backup-for-your-private-key.md" title="Read full history of this post"> <time class="datePublished" datetime="2012-06-14T01:03:28+02:00" itemprop="datePublished">Jun 14, 2012</time> </a> <span class="post-meta-separator">•</span> <span itemprop="read_time"> 12 minutes read </span> <span class="post-meta-separator">•</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-stable" title="Maturity of this article : draft < good < stable or deprecated">stable</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <p><strong>This article focuses on Android and Java keystores, but it applies as well to any key that can be printed as plain text.</strong></p> <p><strong>Before printing a private key, make sure that it is what you need : for instance you would rather print a revocation certificate for an OpenPGP key since you can still sign content with a new key. This is not the case for Android, which requires the same key for every release of an application.</strong></p> <h2 id="securing-a-private-key">Securing a private key</h2> <p>Talking about digital security, there are several techniques to keep a private key secure :</p> <ul> <li>choose strong algorithms with long enough keys</li> <li>choose a strong password (and don’t tell it)</li> <li>keep it in a safe place (don’t copy it on all your USB keys or your phone)</li> <li>be paranoid</li> <li>…</li> </ul> <p>Anyway, there is always a risk that you loose access to your key : whether it was deleted or you’ve lost the password. Because of this you should keep a copy in a safe place.</p> <p>There are <a href="http://www.gnupg.org/gph/en/manual.html#AEN513">many ways</a> to keep a backup key. This article takes the Android case to explain <strong>how to print a private key to paper</strong> so that you can restore it even if your hard disk crashed or if you forgot the password.</p> <h2 id="the-android-case">The Android case</h2> <p><img src="/assets/blog//android-keychain.png" alt="Android keychain" /></p> <p>Android requires developers to <a href="http://developer.android.com/guide/publishing/app-signing.html">sign their applications</a> with a digital certificate and that each future release be signed with the same certificate.</p> <p>Since all releases of an application are signed with the same certificate, the system knows when an update is available for a given application and the end user is seamlessly notified.</p> <p>Sadly, bad things happen when the developer (you) looses access to the certificate : he (you) will not be able to release updates for the application without it. <a href="http://stackoverflow.com/questions/4843212/the-apk-must-be-signed-with-the-same-certificates-as-the-previous-version">Never</a>. <a href="http://stackoverflow.com/search?q=%5Bandroid%5D+lost+keystore">Ever</a>.</p> <p>Android does not currently support multiple certificates per application so <a href="http://stackoverflow.com/questions/2815221/lost-cert-for-published-app">the best you could do</a> would be to release a new app with the same name, in the hope your users will find a way to it by themselves…</p> <p>As years go on, you will have a new computer, wipe USB keys, reinstall OS, … So many dangerous operations for your digital certificates, hidden among millions of files ! If, like me, you are anxious at the idea of losing your certificates or passwords, just print a paper copy ! Although it is not invulnerable, paper should be less prone to mass erasing than a simple electronic file.</p> <p>The idea is <a href="http://en.wikipedia.org/wiki/Paper_key">simple</a>, <a href="http://www.jabberwocky.com/software/paperkey/">not new</a>, and you just need to know two commands to get a printable hard copy of your certificate.</p> <p>Let’s start.</p> <h2 id="java-keystores">Java keystores</h2> <blockquote> <p>Although this article focuses on command line, you can choose the easy way and use <a href="http://www.lazgosoftware.com/kse">a graphical tool</a> to export / import all data.</p> </blockquote> <p>Android uses jarsigner to sign apks (application files). Therefore, your key must live within a “JKS” file (<strong>J</strong>ava <strong>k</strong>ey <strong>s</strong>tore).</p> <p>To deal with JKS you use the <code class="language-plaintext highlighter-rouge">keytool</code> command, which is <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/solaris/keytool.html">included in the JDK</a> (JDK 6+ is required to run commands from this article).</p> <p>Here is a reminder of the <a href="http://developer.android.com/guide/publishing/app-signing.html#cert">Android recommended way</a> to generate a certificate for signing applications :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keytool -genkeypair -keystore mykeys.jks -alias foo -keyalg RSA -keysize 2048 -validity 10000
</code></pre></div></div> <p>With this command, your JKS will be named <code class="language-plaintext highlighter-rouge">mykeys.jks</code> and your certificate aliased as “foo”.</p> <p>It is important to note than <code class="language-plaintext highlighter-rouge">-genkeypair</code> will not only generate a private &amp; public key pair, but also <a href="http://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html#genkeypairCmd">wrap it in a self-signed X509 certificate</a>. The alias you chose will then link to <em>two</em> main distincts components : the private key and the certificate.</p> <p><img src="/assets/blog//android-keystore.png" alt="Fig. 1 - A typical Java keystore with signing material for an Android application" /></p> <h3 id="a-note-about-passwords">A note about passwords</h3> <p>Java keystores support two kind of passwords : the one for the keystore itself, and one for each key (alias) it contains.</p> <p>In this article, we use <code class="language-plaintext highlighter-rouge">openssl</code> to create keys and therefore give them passwords, while the keystore password is always set in the <code class="language-plaintext highlighter-rouge">keytool</code> command.</p> <p>During creation, if you do not provide a password for a key, <code class="language-plaintext highlighter-rouge">keytool</code> will give it the same as the keystore. When reading a key, <code class="language-plaintext highlighter-rouge">keytool</code> will try the keystore password first, so you will only be prompted once if they are the same.</p> <p>Still, <em><code class="language-plaintext highlighter-rouge">keytool</code> does require passwords</em> on both keystore and keys (even if they are the same) and according to the documentation, they must be at least 6 characters long.</p> <p>Therefore, although <code class="language-plaintext highlighter-rouge">openssl</code> allows keys without passwords, <strong>make sure to put one that’s compatible with <code class="language-plaintext highlighter-rouge">keytool</code></strong> (not empty and same as the keystore if you choose so) or you will get cryptic errors like <em>division by zero</em> or <em>Error outputting keys and certificates</em> with :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>139832027854496:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:evp_enc.c:539:
139832027854496:error:23077074:PKCS12 routines:PKCS12_pbe_crypt:pkcs12 cipherfinal error:p12_decr.c:104:
139832027854496:error:2306A075:PKCS12 routines:PKCS12_item_decrypt_d2i:pkcs12 pbe crypt error:p12_decr.c:130:
</code></pre></div></div> <h2 id="exporting-keypair-and-certificate">Exporting keypair and certificate</h2> <p>Since JDK 6, <code class="language-plaintext highlighter-rouge">keytool</code> provides the <code class="language-plaintext highlighter-rouge">-importkeystore</code> command to import / export full data between keystores. Before that, only public parts could be exported. Unfortunately it is still not able to export private data to plain text : you will need to use another tool to achieve this : <code class="language-plaintext highlighter-rouge">openssl</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keytool -importkeystore -srcstoretype jks -srcalias foo -deststoretype pkcs12 -srckeystore mykeys.jks -destkeystore foo.p12
openssl pkcs12 -in foo.p12 -out foo.pem -nodes
</code></pre></div></div> <p>The first command exports all key/certificate data to a binary PKCS12 file. Make sure to give this file the <em>same</em> password as the exported key (see the note about passwords).</p> <p>The second command converts the binary PKCS12 to readable text (also called PEM, or ASCII-armored). By default the private key is still printed encrypted with a symmetric algorithm, so even if you get this key data, you will need the password to unlock it. The option <code class="language-plaintext highlighter-rouge">-nodes</code> bypasses this by allowing the key to be printed <strong>unencrypted</strong>.</p> <p>You end up with two Base64-encoded elements in the file <code class="language-plaintext highlighter-rouge">foo.pem</code> : the private key and the certificate.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bag Attributes
    friendlyName: foo
    localKeyID: 54 69 6D 65 20 31 33 33 39 35 32 31 39 38 37 38 35 37
Key Attributes: &lt;No Attributes&gt;
-----BEGIN PRIVATE KEY-----
MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDJZo94ubcUv+jH
45ljstc7mc0QkLi90Y23wSeR4PYm9TTscuL2y7YoYW74f98HO1IQyw0TGGsCVhiN
... (cut) ...
ibYd/PO20fiHIXRcC8bRejW+rdujiGWbbdkUMtNPv2mSkU1O/EFQ1azz7Luh5qrv
pPuhlcdgBgEznzg0YlS+BIYJfxDaCdXMr/O7Vhr7PuMMcMXHXjSYss/B5P1hCG4+
fQkDExaUGryMbReQWmz8k1PhiA==
-----END PRIVATE KEY-----
Bag Attributes
    friendlyName: foo
    localKeyID: 54 69 6D 65 20 31 33 33 39 35 32 31 39 38 37 38 35 37
subject=/C=FR/ST=France/L=Paris/O=nicobo.net/OU=IT/CN=M. Nicobo
issuer=/C=FR/ST=France/L=Paris/O=nicobo.net/OU=IT/CN=M. Nicobo
-----BEGIN CERTIFICATE-----
MIIDRDCCAiygAwIBAgIET9MM1TANBgkqhkiG9w0BAQUFADBkMQswCQYDVQQGEwJG
UjEPMA0GA1UECBMGRnJhbmNlMQ4wDAYDVQQHEwVQYXJpczESMBAGA1UEChMJRnJl
... (cut) ...
pdl1Nx2TwgaFyjAIMNmXETwwHlCID8bqOvg/4Jg+IkhemTLd0YB56PHYw1+7atMi
t4WQYPsdxrjoT1M7qYo/I6UM9YemmW1sN+XEdpwu130iMPkUflZvewUXtiokK16h
mLjm8v4vbo2SPx40WypprCQf+2H1RcPa
-----END CERTIFICATE-----
</code></pre></div></div> <p>=&gt; <a href="http://nicolabs.github.io/printkey">Print them down</a> and keep the papers in a place safe from dangers like fire, unauthorized people, ….</p> <p><img src="/assets/blog//printedkey.png" alt="Key printed to paper" /></p> <p>You can remove the unnecessary text outside of BEGIN / END blocks. On MS Windows, you may need to convert line breaks - which follow the Unix convention - to read the text.</p> <p>One more advice before printing : make sure to use a font that does display all characters as <em>different</em> symbols or you might not be able to recover the key later. Check especially i,I,l,1 ( (upper &amp; lower ‘i’, ‘L’ and one) and o,O,0 (‘o’ and zero) characters.</p> <h2 id="restoring-the-certificate">Restoring the certificate</h2> <p>When the big day has come and you want to restore your digital certificate from a piece of paper, simply type the key data back into a text file (let’s call it <code class="language-plaintext highlighter-rouge">foo-restored.pem</code>) then run the following commands :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl pkcs12 -export -in foo-restored.pem -out foo-restored.p12
keytool -importkeystore -srckeystore foo-restored.p12 -srcstoretype pkcs12 -destkeystore restored.jks -deststoretype jks -srcalias 1 -destalias foorestored
</code></pre></div></div> <p><em>You could try an OCR software to scan the text from a photo or image. I have not been successful with this yet.</em></p> <p>This time, the first line converts back the PEM data to binary PKCS12. Don’t miss the <code class="language-plaintext highlighter-rouge">-export</code> option, that was not used for the opposite transformation.</p> <p>The second line imports back the key and certificate into your JKS keystore. If it already exists, it will be updated. We did not specify an alias (<code class="language-plaintext highlighter-rouge">-name</code>) for the key on the <code class="language-plaintext highlighter-rouge">openssl</code> command so we use <code class="language-plaintext highlighter-rouge">-srcalias 1</code> to target it. You can choose whatever alias you want for the restored key in your keystore (here <code class="language-plaintext highlighter-rouge">foorestored</code>).</p> <p>Remember : the new password the openssl command asks for will be the password for the key. The new password the <code class="language-plaintext highlighter-rouge">keytool</code> command asks for will be the password for the keystore.</p> <p>Your keystore <code class="language-plaintext highlighter-rouge">restored.jks</code> now contains an exact copy of your lost key : signing with it will produce <em>identical</em> results as signing with the original key.</p> <p><em>If you want to compare two signed jar, compare their content, not the jar themselves : all files must be binary equal (except the name of the key files if you changed it).</em></p> <h2 id="references">References</h2> <ul> <li>keytool : <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/keytool.html">docs.oracle.com/javase/7/docs/technotes/tools/windows/keytool.html</a></li> <li>OpenSSL : <a href="http://www.openssl.org/docs/apps/openssl.html">openssl.org/docs/apps/openssl.html</a> and <a href="http://www.openssl.org/docs/apps/pkcs12.html">openssl.org/docs/apps/pkcs12.html</a> and <a href="http://www.openssl.org/related/binaries.html">openssl.org/related/binaries.html</a> (binaries for windows: ‘light’ version is enough)</li> <li>Android - signing your applications : <a href="http://developer.android.com/guide/publishing/app-signing.html">developer.android.com/guide/publishing/app-signing.html</a></li> <li>Introduction to certificates : <a href="http://www.openssl.org/docs/HOWTO/certificates.txt">openssl.org/docs/HOWTO/certificates.txt</a></li> <li>Help on stackoverflow : <a href="http://stackoverflow.com/questions/652916/converting-a-java-keystore-into-pem-format">stackoverflow.com/questions/652916/converting-a-java-keystore-into-pem-format</a></li> <li>KeyStore Explorer (GUI) : <a href="http://www.lazgosoftware.com/kse/index.html">lazgosoftware.com/kse/index.html</a></li> <li>Jarsigner : <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/jarsigner.html">docs.oracle.com/javase/7/docs/technotes/tools/windows/jarsigner.html</a></li> <li>The GNU Privacy Guard - Defining your security needs : <a href="http://www.gnupg.org/gph/en/manual.html#AEN494">gnupg.org/gph/en/manual.html#AEN494</a></li> <li>X.509 certificates format by PGP : <a href="http://www.pgpi.org/doc/pgpintro">pgpi.org/doc/pgpintro</a></li> <li>Maybe an alternative : signing with several certificates at the same time (not tested)</li> <li>Tesseract - an open source OCR software : <a href="http://code.google.com/p/tesseract-ocr/">code.google.com/p/tesseract-ocr/</a></li> <li><a href="http://en.wikipedia.org/wiki/Paper_key">en.wikipedia.org/wiki/Paper_key</a></li> <li>Paperkey - an OpenPGP key archiver : <a href="http://www.jabberwocky.com/software/paperkey/">jabberwocky.com/software/paperkey/</a></li> <li>Safeberg’s ® Trusted Paper Key : <a href="http://www.safeberg.com/en/howitworks/usagetrustedpaperkey">safeberg.com/en/howitworks/usagetrustedpaperkey</a></li> <li>Print a GPG key : <a href="https://wiki.debian.org/Keysigning">wiki.debian.org/Keysigning</a></li> <li>Pretty-print your key with this form : <a href="https://github.com/nicolabs/printkey">github.com/nicolabs/printkey</a></li> </ul> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#android">#android</a></li> <li class="tag"><a href="/tags#certificate">#certificate</a></li> <li class="tag"><a href="/tags#cryptography">#cryptography</a></li> <li class="tag"><a href="/tags#java">#java</a></li> <li class="tag"><a href="/tags#keytool">#keytool</a></li> <li class="tag"><a href="/tags#openssl">#openssl</a></li> <li class="tag"><a href="/tags#printkey">#printkey</a></li> <li class="tag"><a href="/tags#security">#security</a></li> </ul> </aside> <!--aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=A paper backup for your private key&amp;url=https://www.nicolabs.net/articles/paper-backup-your-private-key&amp;hashtags=web,dev,blog,soudev&amp;via=" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.nicolabs.net/articles/paper-backup-your-private-key" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside--> </div> </article> <footer class="site-footer"> <div class="container"> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
