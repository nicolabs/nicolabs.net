<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> nicolabs | Tweaking Android Notifications </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2011-08-11 23:11:59 +0200"> <meta property="og:url" content="https://www.nicolabs.net/articles/tweaking-android-notifications"> <meta property="og:title" content=" nicolabs | Tweaking Android Notifications "> <meta property="og:image" content="https://www.nicolabs.net"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="nic0b0"> <meta name="twitter:title" content=" nicolabs | Tweaking Android Notifications "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="https://www.nicolabs.net"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | Tweaking Android Notifications "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="https://www.nicolabs.net"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="https://www.nicolabs.net/articles/tweaking-android-notifications"> <link type="application/atom+xml" rel="alternate" href="https://www.nicolabs.net/feed.xml" title="nicolabs" /> <script type="text/javascript"> var disqus_shortname = 'nicolabs'; </script> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/articles">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Tweaking Android Notifications</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_posts/2011-08-11-Tweaking-Android-Notifications.md" title="Read full history of this post"> <time class="datePublished" datetime="2011-08-11T23:11:59+02:00" itemprop="datePublished">Aug 11, 2011</time> </a> <span class="post-meta-separator">•</span> <span itemprop="read_time"> 10 minutes read </span> <span class="post-meta-separator">•</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-deprecated" title="Maturity of this article : draft < good < stable or deprecated">deprecated</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <blockquote> <p>This is a technical article aimed at Android developers. It deals with <strong>undocumented features</strong> of the Android API and derives from experimental work.</p> <p>You can browse and download the sample code included in this article at <a href="http://bitbucket.org/nicobo/tweaking-android-notifications">bitbucket.org/nicobo/tweaking-android-notifications</a>.</p> </blockquote> <p>For <a href="http://bitbucket.org/nicobo/switchdataswitch">SwitchDataSwitch</a>, I wanted to provide users with a 1-click solution to enable and disable data traffic (2G/3G/…). I chose the notification bar since it is a very accessible place, visible almost all the time and that can be expanded without stopping the running activity :</p> <p><img src="/assets/blog/slidenotificationbar-2.png" alt="Expanding the notification bar" /></p> <p>The notification bar is usually presented in its <strong>reduced form</strong> (here the dark bar at the top of the screen with the smallest icons) but can be <strong>expanded</strong> by sliding it downwards.</p> <p>Unfortunately, <a href="http://developer.android.com/reference/android/app/Notification.html">Android’s Notification API</a> is really made for instant notifications, not persistent ones, and that implies several inconveniences :</p> <ul> <li>when creating a notification, the developer has to put an icon in the reduced notification bar, taking some precious space</li> <li>by default an ‘event timestamp’ is shown next to the expanded content of the notification, which means nothing for a permanent service</li> <li>there is no programmatic way to know if a notification is currently displayed or not</li> </ul> <p>This article describes a way to create a notification that :</p> <ul> <li>doesn’t show up in the reduced notification bar</li> <li>doesn’t have a timestamp in the expanded notification bar</li> </ul> <p>I haven’t found a reusable way to know if a notification is currently displayed…</p> <h2 id="creating-the-notification">Creating the Notification</h2> <p>Let’s do it step by step, by following the process of notification creation as I understand it.</p> <h3 id="declaring-the-intent-and-the-notification">Declaring the Intent and the Notification</h3> <p>The notification is first declared as usual (you might want to check <a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html">the online reference doc</a>) :</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The Intent that will be called upon a click on the notification</span>
<span class="nc">Intent</span> <span class="n">notificationIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">NotifyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Builds the notification view as it should be displayed in the end</span>
<span class="nc">Notification</span> <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_notif</span><span class="o">,</span> <span class="s">"My notification has just been displayed"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div></div> <p>Note that the icon <code class="language-plaintext highlighter-rouge">R.drawable.icon_notif</code> we provided to the <a href="http://developer.android.com/reference/android/app/Notification.html#Notification%28int,%20java.lang.CharSequence,%20long%29"><code class="language-plaintext highlighter-rouge">android.app.Notification</code></a> constructor is really the final one that will be displayed when the user will expand the notification bar : no trick for now.</p> <h3 id="initializing-the-notification-view">Initializing the notification view</h3> <p>This is still quite standard code for Android :</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Sets the flags that will determine the behaviour of the notification</span>
<span class="c1">// the following tells that there is something currently running</span>
<span class="c1">// and places the notification in the 'ongoing' category</span>
<span class="n">notification</span><span class="o">.</span><span class="na">flags</span> <span class="o">|=</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">FLAG_ONGOING_EVENT</span><span class="o">;</span>
<span class="c1">// the following ensures that the notification will not be removed</span>
<span class="c1">// if the user chooses to clear notifications</span>
<span class="n">notification</span><span class="o">.</span><span class="na">flags</span> <span class="o">|=</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">FLAG_NO_CLEAR</span><span class="o">;</span>

<span class="c1">// Defines the notification's expanded message</span>
<span class="nc">CharSequence</span> <span class="n">contentTitle</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">app_name</span><span class="o">);</span>
<span class="nc">CharSequence</span> <span class="n">contentText</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">notification_text</span><span class="o">);</span>

<span class="c1">// Wraps our Intent with a PendingIntent instance</span>
<span class="nc">PendingIntent</span> <span class="n">contentIntent</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">notificationIntent</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

<span class="c1">// Injects all the elements into the notification</span>
<span class="n">notification</span><span class="o">.</span><span class="na">setLatestEventInfo</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">contentTitle</span><span class="o">,</span> <span class="n">contentText</span><span class="o">,</span> <span class="n">contentIntent</span><span class="o">);</span>
</code></pre></div></div> <p>On the last line, calling <a href="http://developer.android.com/reference/android/app/Notification.html#setLatestEventInfo%28android.content.Context,%20java.lang.CharSequence,%20java.lang.CharSequence,%20android.app.PendingIntent%29"><code class="language-plaintext highlighter-rouge">Notification.setLatestEventInfo(...)</code></a> <strong>sets the layout of our Notification</strong>. Now we can start tweaking it !</p> <p>Note that if we were to build a more standard notification but still with no timestamp displayed next to it, we could set <a href="http://developer.android.com/reference/android/app/Notification.html#when"><code class="language-plaintext highlighter-rouge">notification.when</code></a><code class="language-plaintext highlighter-rouge">=0</code> at this point to disable the display of the timestamp.</p> <h3 id="tweaking-the-notification">Tweaking the notification</h3> <blockquote> <p>EDIT : Since Android Jelly Bean (4.1) you don’t need the trick explained in this chapter anymore : you can hide icons from the notification bar simply by setting a <code class="language-plaintext highlighter-rouge">priority</code> field to <code class="language-plaintext highlighter-rouge">PRIORITY_MIN</code>.</p> </blockquote> <p>This <em>is</em> the interesting part !</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * The time of the notification rules if it is aligned to the right or left
 * of the notification bar, and therefore we use it to place the empty icon
 * where it will not be noticed by the user.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">TIME_HIDDEN</span> <span class="o">=</span> <span class="no">SDK_VERSION</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="o">?</span> <span class="o">-</span><span class="nc">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">:</span> <span class="nc">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>

<span class="c1">// ...</span>

<span class="c1">// 1. After the notification's layout has been filled, we reset the time that will be used</span>
<span class="c1">// to place it on the edge of the notification bar in order to hide its icon</span>
<span class="n">notification</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="no">TIME_HIDDEN</span><span class="o">;</span>

<span class="c1">// 2. The following line only changes the icon displayed in the notification bar when reduced.</span>
<span class="c1">// The icon displayed in the expanded view is still the one that was initially set.</span>
<span class="c1">// Together with a placement to the right (or left depending on the SDK version), it hides the icon.</span>
<span class="n">notification</span><span class="o">.</span><span class="na">icon</span> <span class="o">=</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_hidden</span><span class="o">;</span>

<span class="c1">// 3. Triggers the notification.</span>
<span class="nc">NotificationManager</span> <span class="n">mNotificationManager</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NotificationManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">);</span>
<span class="n">mNotificationManager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="no">MYNOTIFS_1</span><span class="o">,</span> <span class="n">notification</span><span class="o">);</span>
<span class="c1">// After that, we cannot tell about the state of the notification...</span>
</code></pre></div></div> <p>It is very important to place this code <strong>after</strong> the call to <a href="http://developer.android.com/reference/android/app/Notification.html#setLatestEventInfo%28android.content.Context,%20java.lang.CharSequence,%20java.lang.CharSequence,%20android.app.PendingIntent%29"><code class="language-plaintext highlighter-rouge">Notification.setLatestEventInfo(...)</code></a>, to make sure that the notification’s view has already been built.</p> <p>The magic happens in two steps :</p> <ol> <li>we move the icon to the edge of the bar so that it doesn’t take some place <strong>between</strong> 2 other icons</li> <li>we replace the original icon with a <strong>transparent 1x1 px icon</strong> (<code class="language-plaintext highlighter-rouge">R.drawable.icon_hidden</code>)</li> </ol> <p>The first step simply implies defining a fake timestamp that will be the greatest (<code class="language-plaintext highlighter-rouge">Long.MAX_VALUE</code>) or the smallest possible one (<code class="language-plaintext highlighter-rouge">-Long.MAX_VALUE</code>) so that the icon will be placed before of after any other icon (that has a reasonable timestamp). To know which value to use, we must <a href="http://stackoverflow.com/questions/2855110/android-no-icon-for-notification">test the SDK version</a>.</p> <p>The other step is to replace the icon with a transparent one, making it invisible to the user. We simply used a transparent PNG image. The best part is that the icon we used to build the Notification is still there when the notification bar is expanded, it is not replaced with the transparent one…</p> <p>The last lines are standard Android code that trigger the notification.</p> <p><strong><em>Et voilà !</em></strong></p> <h2 id="some-more-details">Some more details</h2> <blockquote> <p>Note : each of the following cases is included with the sample app attached to this article (see “references” below).</p> </blockquote> <h3 id="playing-with-the-timestamp">Playing with the timestamp</h3> <p>If you are curious, you might want to see what happens if you set <a href="http://developer.android.com/reference/android/app/Notification.html#when"><code class="language-plaintext highlighter-rouge">Notification.when</code></a><code class="language-plaintext highlighter-rouge"> = TIME_HIDDEN</code> before calling <a href="http://developer.android.com/reference/android/app/Notification.html#setLatestEventInfo%28android.content.Context,%20java.lang.CharSequence,%20java.lang.CharSequence,%20android.app.PendingIntent%29"><code class="language-plaintext highlighter-rouge">Notification.setLatestEventInfo(...)</code></a> :</p> <p><img src="/assets/blog/longdate-zoom.png" alt="The notification with a long date next to it" /></p> <p>This date is very long and has no meaning for us…</p> <p>If you don’t change <code class="language-plaintext highlighter-rouge">Notification.when</code> at all, the icon is placed depending on its creation time (notifications are sorted on their timestamp) :</p> <p><img src="/assets/blog/visibleicon-zoom.png" alt="A space is visible between 2 icons of the notification bar" /></p> <p>There is an empty place between two icons of the notification bar : this is our transparent icon.</p> <p>In general, if you want to have more control on the date displayed next to the notification text, simply set the <code class="language-plaintext highlighter-rouge">when</code> field right before calling <code class="language-plaintext highlighter-rouge">setLatestEventInfo(...)</code>.</p> <h3 id="an-alternative">An alternative</h3> <p>Finally, instead of building a default view for the notification and then tweaking it, we could build a custom notification view.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The following code makes uses a custom layout for the notification.</span>
<span class="nc">RemoteViews</span> <span class="n">contentView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RemoteViews</span><span class="o">(</span><span class="n">getPackageName</span><span class="o">(),</span> <span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">notification</span><span class="o">);</span>
<span class="n">contentView</span><span class="o">.</span><span class="na">setImageViewResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">image</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon</span><span class="o">);</span>
<span class="n">contentView</span><span class="o">.</span><span class="na">setTextViewText</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title</span><span class="o">,</span> <span class="n">contentTitle</span><span class="o">);</span>
<span class="n">contentView</span><span class="o">.</span><span class="na">setTextViewText</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text</span><span class="o">,</span> <span class="n">contentText</span><span class="o">);</span>
<span class="n">notification</span><span class="o">.</span><span class="na">contentView</span> <span class="o">=</span> <span class="n">contentView</span><span class="o">;</span>
<span class="n">notification</span><span class="o">.</span><span class="na">contentIntent</span> <span class="o">=</span> <span class="n">contentIntent</span><span class="o">;</span>
</code></pre></div></div> <p>There is <a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html#CustomExpandedView">some documentation</a> about this cool option, but be aware that this could easily lead to build views that are not consistent with the OS’ default style…</p> <p>Even though it allows us to hide the timestamp in the expanded view, it doesn’t help hiding the icon in the reduced notification bar, so in our case this option is not quite helpful… Also, I could not make it work on Android 1.5 (I neither tried nor investigated further).</p> <h2 id="end-note">End note</h2> <p>Don’t forget <strong>this is experimental work</strong>, and the method described in this article may not be available on all devices, and could be deprecated as well in future releases of Android. However, the app I’ve created based on this article has already been installed on several kind of devices without issue so you may be confident for now… I’ll update this article whenever I have feedback about it.</p> <p><em>Happy notifying !</em></p> <h2 id="references">References</h2> <ul> <li><a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html">Official documentation about notifications</a></li> <li><a href="http://developer.android.com/reference/android/app/Notification.html">Notification API</a></li> <li><a href="http://stackoverflow.com/questions/2855110/android-no-icon-for-notification">The magic recipe to set <code class="language-plaintext highlighter-rouge">Notification.when</code></a></li> <li>If you want to see the app for which I’ve been doing all this : <a href="http://bitbucket.org/nicobo/switchdataswitch">bitbucket.org/nicobo/switchdataswitch</a></li> <li><a href="http://bitbucket.org/nicobo/tweaking-android-notifications">Browse the sources of the sample application</a> or <a href="/assets/blog/tweaking-android-notifications.zip">download .zip file</a></li> <li><a href="http://developer.android.com/design/patterns/notifications.html">Interesting article about Google’s vision of notifications</a></li> <li><a href="http://developer.android.com/about/versions/jelly-bean.html">New notifications API in Jelly Bean</a> and <a href="http://www.youtube.com/watch?feature=player_detailpage&amp;v=Yc8YrVc47TI#t=1667s">youtube.com/watch?feature=player_detailpage&amp;v=Yc8YrVc47TI#t=1667s</a></li> </ul> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#android">#android</a></li> <li class="tag"><a href="/tags#switchdataswitch">#switchdataswitch</a></li> </ul> </aside> <aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=Tweaking Android Notifications&amp;url=https://www.nicolabs.net/articles/tweaking-android-notifications&amp;hashtags=web,dev,blog,soudev&amp;via=nic0b0" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.nicolabs.net/articles/tweaking-android-notifications" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside> </div> </article> <footer class="site-footer"> <div class="container"> <small class="pull-left">&copy;2023 All rights reserved.</small> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
