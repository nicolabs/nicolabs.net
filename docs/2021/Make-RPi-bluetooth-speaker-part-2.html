<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="shortcut icon" type="image/png" href="/assets/about/favicon.ico"> <title> nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 2) </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2021-08-20 15:16:34 +0200"> <meta property="og:url" content="http://*:4000/2021/Make-RPi-bluetooth-speaker-part-2"> <meta property="og:title" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 2) "> <meta property="og:image" content="http://*:4000"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 2) "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="http://*:4000"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | Make a Raspberry Pi a Bluetooth speaker (part 2) "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="http://*:4000"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/cactus.css" type="text/css"> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://*:4000/2021/Make-RPi-bluetooth-speaker-part-2"> <link type="application/atom+xml" rel="alternate" href="http://*:4000/feed.xml" title="nicolabs" /> <script type="text/javascript" src="/assets/lib/cactus.js"></script> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/articles">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Make a Raspberry Pi a Bluetooth speaker (part 2)</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_drafts/Make-RPi-bluetooth-speaker-part-2.md" title="Read full history of this post"> <time class="datePublished" datetime="2021-08-20T15:16:34+02:00" itemprop="datePublished">Aug 20, 2021</time> </a> <span class="post-meta-separator">•</span> <span itemprop="read_time"> 6 minutes read </span> <span class="post-meta-separator">•</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-unpublished" title="Maturity of this article : draft < good < stable or deprecated">unpublished</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <p><img src="/assets/blog/3rdparty/pictures/800px-Raspberry_Pi_4.jpg" alt="Raspberry Pi 4 - https://www.raspberrypi.org / CC BY-SA (https://creativecommons.org/licenses/by-sa/4.0)" /></p> <p>In this two-part article I describe the steps I had to take to make a <em>headless Raspberry Pi 4</em> a Bluetooth A2DP speaker.</p> <p>The exact goal was to offer a user-friendly way for anyone in the room to pair its Bluetooth smartphone with the Raspberry Pi and play music through it, while making sure the neighbors won’t be able to connect without approval.</p> <hr /> <p><em>This is a two-part article :</em></p> <ol> <li><em><a href="Make-RPi-bluetooth-speaker-part-1">How Bluetooth pairing works</a> (part 1)</em></li> <li><em>Raspberry Pi as a Bluetooth A2DP receiver (this part)</em></li> </ol> <hr /> <p>Now that we’ve seen how Bluetooth pairing works, what does it take to make a Raspberry Pi a Bluetooth A2DP receiver ?</p> <h2 id="the-basis">The basis</h2> <p>First, there are several solutions to enable Bluetooth A2DP in linux : it takes at least a bluetooth listener, an audio driver and a way to forward the first to the last.</p> <p>I’ve found the following solution working :</p> <ol> <li><a href="https://thecodeninja.net/2016/06/bluetooth-audio-receiver-a2dp-sink-with-raspberry-pi/">This article</a> explains the generic way to do it with <em>bluez</em> and <em>pulseaudio</em> but is for <em>xbian</em> and uses a GUI</li> <li>This one gives specific instructions for the Raspberry Pi</li> <li>This one adds headless instructions</li> <li>This one adds automatic pairing instructions</li> <li><a href="http://bluetooth-pentest.narod.ru/software/bluetooth_class_of_device-service_generator.html">This one</a> allow to find the best bluetooth class depending on the hardware</li> </ol> <h2 id="audio--volume-tuning">Audio / Volume tuning</h2> <ul> <li><code class="language-plaintext highlighter-rouge">amixer set Master 100%</code> since the Rpi’s audio output is not loud enough (I have to set the volume of my Hi-Fi to the maximum). It also sets the volume of the <em>sink</em> in PulseAudio ; see more audio tuning here : https://www.instructables.com/id/Turn-your-Raspberry-Pi-into-a-Portable-Bluetooth-A/</li> <li>amixer only displays a ‘Mono’ channel : how to make sure it sources &amp; sinks stereo from the BT devices ?</li> <li>It is also possible to set sink volume through PulseAudio with pacmd command. In my experience both amixer and pacmd correctly set the volume for ALSA and PulseAudio. However <em>source</em> volume might not be set to its maximum by default (?) : <code class="language-plaintext highlighter-rouge">pacmd set-source-volume 0 65537</code> (and optionally <code class="language-plaintext highlighter-rouge">pacmd set-sink-volume 0 65537</code>). Run <code class="language-plaintext highlighter-rouge">pacmd dump-volumes</code> to print current PA volumes.</li> </ul> <h2 id="todo">TODO</h2> <p>The problems described <a href="http://youness.net/raspberry-pi/bluetooth-headset-raspberry-pi-3-ad2p-hsp">here</a> might not apply to Rpi 4 as it seems to have a <em>bcm2835</em> ?</p> <p>Why turning discovery off while a device is already connected ?</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Turn off BT discover mode before connecting existing BT device to audio
hciconfig hci0 noscan
</code></pre></div></div> <h2 id="custom-agent">Custom agent</h2> <p>Some crafted implementations I found around seemed to do the job but their code was not clear enough so while I introspected them to understand what they were doing and why, I ended up writing a new one, matching my use case.</p> <p>Now let’s identify which association model(s) fits our use case.</p> <h3 id="implementing-a-headless-validation-mechanism">Implementing a headless validation mechanism</h3> <p>In any of <em>Numeric Comparison</em>, <em>Just Works</em> and <em>Passkey Entry</em> we’ve seen that to fulfill our requirements we will need to implement some way to confirm that the device trying to connect is authorized. Bluetooth specifies this as “displaying” a number but they really mean “communicate to the device’s owner”.</p> <p>This could be done in several ways.</p> <p>Whitelist</p> <p>Bluetooth MAC address : it may probably be spoofed</p> <p>a Yes/No validation mechanism to validate any connection attempt.</p> <p>Concretely, it would be possible by make the RPi speak aloud the code or send it to a human “admin” (e.g. via instant messaging), then have him validate with some external mechanism (e.g. answering back “Yes” aloud or through his own smartphone). This could be an application on the admin’s smartphone (chat, custom one, …) or a custom agent on the RPi listening to the admin’s vocal “OK”, but it looks like there is no solution out of the box today…</p> <p>A headless device may then adopt one of the following options :</p> <ul> <li>simply allow any device to connect ; data exchanges can still be secured, but will not protect against a MITM attack</li> <li>use a program (a <em>bot</em> actually) to simulate a user input, making sure no random number would need to be input</li> <li>develop advanced headless inputs (like audio speak / voice recognition)</li> <li>leverage on Out-of-Band protocol ?</li> </ul> <h4 id="just-works-with-bluez">Just works with BlueZ</h4> <p>If a <em>Just Works</em> model is triggered, the bluetooth agent may automatically pair with devices without a confirmation, or it may ask by some “headless” way a confirmation. In the first case, although data exchange can be strongly secured, it cannot prevent an unknown device to pair. In the latter case, it may require a fair amount of work to build such a confirmation mechanism.</p> <p>Depending on the capabilities the <em>agent</em> advertised, it may never be called in this association model.</p> <h2 id="references">References</h2> <ul> <li>Top illustration : <a href="https://commons.wikimedia.org/wiki/File:Raspberry_Pi_4.jpg">Raspberry Pi 4 by https://www.raspberrypi.org/</a> / <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA</a></li> <li><a href="https://github.com/nicokaiser/rpi-audio-receiver/blob/master/README.md">nicokaiser/rpi-audio-receiver @ github</a> : I’ve tried it on my RPi 4 : althought it looks promising it doesn’t work ootb</li> <li><a href="https://www.instructables.com/id/Turn-your-Raspberry-Pi-into-a-Portable-Bluetooth-A/">Turn Your Raspberry Pi Into a Wireless Portable Bluetooth Audio System A2DP</a></li> <li><a href="http://youness.net/raspberry-pi/how-to-connect-bluetooth-headset-or-speaker-to-raspberry-pi-3">How To Connect Bluetooth Headset Or Speaker To Raspberry Pi 3</a></li> </ul> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#raspberry-pi">#raspberry pi</a></li> <li class="tag"><a href="/tags#bluetooth">#bluetooth</a></li> <li class="tag"><a href="/tags#series-make-a-raspberry-pi-a-bluetooth-speaker">#Series : Make a Raspberry Pi a Bluetooth speaker</a></li> </ul> </aside> <!--aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=Make a Raspberry Pi a Bluetooth speaker (part 2)&amp;url=http://*:4000/2021/Make-RPi-bluetooth-speaker-part-2&amp;hashtags=web,dev,blog,soudev&amp;via=" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://*:4000/2021/Make-RPi-bluetooth-speaker-part-2" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside--> </div> </article> <div id="comment-section"></div> <script> initComments({ node: document.getElementById("comment-section"), defaultHomeserverUrl: "https://matrix.cactus.chat:8448", serverName: "cactus.chat", /* Chat room name will be the concatenation of 'comments_', siteName, '_', commentSectionId. E.g. #comments_nicolabs.net_LineageOS4microg-Upgrade:cactus.chat */ siteName: "nicolabs.net", /* Don't use page.url as slashes are not supported : https://gitlab.com/cactus-comments/cactus-client/-/issues/62 */ commentSectionId: "Make-RPi-bluetooth-speaker-part-2" }) </script> <noscript>Please enable JavaScript to view the <a href="https://cactus.chat" rel="nofollow">comments powered by matrix.org.</a></noscript> <footer class="site-footer"> <div class="container"> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
