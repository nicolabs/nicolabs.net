<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="shortcut icon" type="image/png" href="/assets/about/favicon.ico"> <title> nicolabs | Ansible : love and hate </title> <meta name="description" content=" Work in progress... "> <meta name="keywords" content="android, development, java, javascript, python, web"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="nicobo"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2024-09-12 09:28:34 +0200"> <meta property="og:url" content="http://*:4000/2024/Playing-with-ansible"> <meta property="og:title" content=" nicolabs | Ansible : love and hate "> <meta property="og:image" content="http://*:4000"> <meta property="og:description" content=" Work in progress... "> <meta property="og:site_name" content="nicobo"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" nicolabs | Ansible : love and hate "> <meta name="twitter:description" content=" Work in progress... "> <meta name="twitter:image:src" content="http://*:4000"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" nicolabs | Ansible : love and hate "> <meta itemprop="description" content=" Work in progress... "> <meta itemprop="image" content="http://*:4000"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/cactus.css" type="text/css"> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://*:4000/2024/Playing-with-ansible"> <link type="application/atom+xml" rel="alternate" href="http://*:4000/feed.xml" title="nicolabs" /> <script type="text/javascript" src="/assets/lib/cactus.js"></script> <!-- Enable displaying pictures in full size using the Fullscreen API --> <!-- A polyfill that also simplifies the API. TODO maybe there are others closer to the norm and with more features. Still chances are this will not work on iPhone without using a full-fledged Js library. --> <script src="/assets/lib/screenfull.js/dist/screenfull.min.js"></script> <!-- This code selects which elements and how fullscreen is triggered --> <script> document.addEventListener("DOMContentLoaded", function(event) { var els = document.getElementsByClassName("plantuml"); for ( var e=0 ; e<els.length ; e++ ) { var el = els[e]; el.addEventListener('click', function() { if (screenfull.isEnabled) { screenfull.toggle(el); el.classList.toggle("fullscreen"); } else { console.log("Fullscreen not supported"); } }); } }); </script> <script> window.onscroll = function() { if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) { document.querySelector('.site-header').classList.add('site-header-pinned'); } else { document.querySelector('.site-header').classList.remove('site-header-pinned'); } }; </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">nico<span>labs</span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/articles">articles</a></li> <li><a href="/feed.xml">feed</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Ansible : love and hate</h1> <p class="post-meta"> <a href="https://github.com/nicolabs/nicolabs.github.io/commits/master/_drafts/Playing-with-ansible.md" title="Read full history of this post"> <time class="datePublished" datetime="2024-09-12T09:28:34+02:00" itemprop="datePublished">Sep 12, 2024</time> </a> <span class="post-meta-separator">‚Ä¢</span> <span itemprop="read_time"> 16 minutes read </span> <span class="post-meta-separator">‚Ä¢</span> <span itemprop="maturity"><a href="/2016/Migrating-from-Drupal-to-Jekyll" title="Maturity of this article : draft < good < stable or deprecated&#xa;Click for the explanation.">Maturity : <span class="maturity-label maturity-unpublished" title="Maturity of this article : draft < good < stable or deprecated">unpublished</span> </span></a> </p> </header> <div class="post-content" itemprop="articleBody"> <p><a href="https://ansible.com">Ansible</a> is a very good tool : with only a SSH connection and Python installed on remote machines you can automate the deployment of a whole pool of machines. However I‚Äôve encountered that may be of some interest for newcomers.</p> <h2 id="how-to-use-tags">How to use tags</h2> <p>The possibility to <em>tag</em> tasks is a very good thing but the documentation is not clear on what can be achieved.</p> <p>TODO always, never, all, setup, cleanup</p> <p>When using <code class="language-plaintext highlighter-rouge">--tags foo</code> it disables all tasks and only runs those tagged with <em>foo</em>. This seems actually logical but may be counter-intuitive for instance if you wanted to use it for a one-time activation of some tasks tagged with <em>never</em>, <strong>in addition</strong> to the usual ones it will fail : if they‚Äôre not tagged with <em>foo</em> or <em>always</em>, usual tasks will not be run. You then may tag all usual/default tasks with <em>always</em> to make sure they are run with or without <code class="language-plaintext highlighter-rouge">--tags</code> by default, but then how will you run <strong>just a selection</strong> of tasks with a given tag (e.g. <code class="language-plaintext highlighter-rouge">--tags bluetooth</code> to run only the roles/tasks that configure bluetooth) ?</p> <p>What if a task has both <em>always</em> and <em>never</em> ? This can happen with inheritance (e.g. a block is tagged with <em>always</em> but a task inside this block is tagged with <em>never</em> so it‚Äôs not executed by default). The documentation does not say it explicitely, but <em>always</em> wins (so in my example will not work).</p> <p>What happens with <code class="language-plaintext highlighter-rouge">--all,never</code> ? Are tasks tagged with <em>never</em> run since they <strong>do</strong> have a tag ?</p> <p>No user-friendly way to run only a (set of) role(s) in a playbook. The official recommended way is to use tags. One can run <a href="https://stackoverflow.com/questions/38350674/ansible-can-i-execute-role-from-command-line"><code class="language-plaintext highlighter-rouge">ansible localhost -m include_role -a name=&lt;role_name&gt;</code></a> but the syntax is not appealing‚Ä¶ Maybe <a href="https://github.com/larsks/ansible-toolbox">ansible-toolbox</a> ?</p> <p>Let‚Äôs now say that you have tagged all the tasks of a role ‚Äúmyrole‚Äù inside the <code class="language-plaintext highlighter-rouge">myrole/tasks/main.yml</code> using inheritance. If you use <code class="language-plaintext highlighter-rouge">--tags myrole</code> in order to run only the tasks related to this role within a playbook, be aware that it will still run tasks tagged with <strong>always</strong>, which you probably didn‚Äôt want to enable under such circumstances ! You would have to use <code class="language-plaintext highlighter-rouge">--tags myrole --skip-tags always</code>, which is counter-intuitive ! =&gt; cannot use a tag for selecting a role if others contain ‚Äòalways‚Äô tags (which is often the case in third-party roles). This can also be counter-intuitive with <strong>never</strong> : if you tagged all steps of your role with <em>myrole</em> and some of them with <em>never</em> so they should only be called with <code class="language-plaintext highlighter-rouge">--tags never</code>, then you can only achieve this with <code class="language-plaintext highlighter-rouge">--tags myrole --skip-tags never</code> ! But this is incompatible with the previous behaviour described with <em>always</em> !!! =&gt; cannot use a tag for selecting a role if it contains also ‚Äònever‚Äô tags</p> <p>What if you want to run only the tasks that have several tags at the same time (e.g. <em>nextcloud</em> AND <em>docker</em>, which together designates the ‚Äòdocker‚Äô version of the ‚Äònextcloud‚Äô task/role) ? I could not find a way other than creating a third <em>nextcloud-docker</em> tag‚Ä¶ Ansible misses here <em>operations</em> on tags (basic boolean operations would be great although many similar systems have also complex <em>glob</em> or <em>regex</em> filtering)</p> <p>I‚Äôve run into the following problem : if you include a third-party role that does not use the same tagging conventions, then you can just forget about using tags to select which roles to run‚Ä¶</p> <h2 id="todo">TODO</h2> <p>Nom des variables avec underscore est la convention (mais √©crit nulle part ?). En termes de conception c‚Äôest null : tout est mis √† plat plut√¥t que de regrouper en ‚Äònamespaces‚Äô, ce qui donnerait une isolation plus claire.</p> <p>Impossible de d√©finir des structures yaml √† sp√©cialiser dans les variables des r√¥les : il faut mettre une liste de variables √† plat.</p> <p>Je regarde presque √† chaque fois le manuel des t√¢ches =&gt; prouve que ce n‚Äôest pas intuitif ; ou encore copier-coller</p> <p>Avantage : force √† bien d√©couper et dissocier les d√©pendances</p> <p>Inconv√©nient : parfois force √† trop d√©couper (difficile de trouver le juste milieu entre le d√©coupage absolu qui est incompr√©hensible, complexe et du coup difficile √† maintenir alors que c‚Äôest cens√© aider √† la maintenance et trop de duplications / parties en dur)</p> <p>Sometimes (it happened several times to me already, I cannot count the hours I lost because of this) dependencies are needed at runtime for <strong>ansible</strong> modules or filters (e.g. docker, json_query, ‚Ä¶). The task will just fail and there is not clean way to make sure the dependencies are there other than installing them yourself using a task. So your playbooks/roles become cluttered with those meta-dependencies you should not deal with and it won‚Äôt let you run with -C until you installed them once or run the task without -C first !!! E.g. https://github.com/ansible/ansible/issues/24319</p> <p>Error messages are not clear because there is too many levels of indirection. It‚Äôs even stated in error messages : <code class="language-plaintext highlighter-rouge">The error appears to have been in '/root/ansible/setup.yaml': line 9, column 12, but may be elsewhere in the file depending on the exact syntax problem.</code>. The first time I mistyped the root password when ansible asked me I‚Äôve just lost 1 or 2 hours finding the cause because the error was on an (apparently) unrelated task‚Ä¶</p> <p>Bug des loop imbriqu√©es :</p> <blockquote> <p>Attention, en plus de n√©cessiter 3 (!) fichiers pour imbriquer 2 boucles, si la variable ‚Äòitem‚Äô est utilis√©e dans des boucles imbriqu√©es cela fait planter avec un message ~ ‚Äúincompatible type dict au lieu de string‚Äù !!! ‚Äì&gt; utiliser des loop_var distincts !</p> </blockquote> <h2 id="passwordstore-integration">Passwordstore integration</h2> <p>Using password store to automate SSH / sudo.</p> <h2 id="order-is-important">Order is important</h2> <p>e.g.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- command:
  loop:
  - "agent off"
  - "scan on"
      cmd: "bluetoothctl -- "
</code></pre></div></div> <p>is not working but :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- loop:
  - "agent off"
  - "scan on"
  command:
      cmd: "bluetoothctl -- "
</code></pre></div></div> <p>does. YAML syntax.</p> <p>Same for tags that I had to put to the end in blocks.</p> <h2 id="the-bad--demonstration">The bad : demonstration</h2> <p>Here is a simple use case :</p> <p>You need to <em>fetch</em> public keys from a file on each remote hosts and save them together in a directory on the local host. On each host, the key is located at the same place : <code class="language-plaintext highlighter-rouge">/home/me/.keys/me.pub</code>. You want it to be to stored locally at <code class="language-plaintext highlighter-rouge">/var/keys/.pub</code>.</p> <p>Fortunately, ansible <strong>does</strong> have a <em><a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fetch_module.html">fetch</a></em> module :</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">name</span><span class="pi">:</span> <span class="s">Fetch the remote public key</span>
  <span class="na">fetch</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">/home/me/.keys/me.pub</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/var/keys/.pub</span>
    <span class="na">flat</span><span class="pi">:</span> <span class="s">yes</span>
</code></pre></div></div> <p>Well, according to the docs, it will just not work.</p> <p>First, you have to specify <code class="language-plaintext highlighter-rouge">flat: yes</code> otherwise the file will be saved into :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/keys/.pub//home/me/.keys/me.pub
</code></pre></div></div> <p>What ? ü§î</p> <p>Ok, they‚Äôve chosen a weird default behavior‚Ä¶ But even with <code class="language-plaintext highlighter-rouge">flat: yes</code>, according to the docs, you will end up with the file copied into the wrong place :</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/keys/.pub/me.pub
</code></pre></div></div> <p>What. The. Hell. üôÑ</p> <p>Fortunately, the doc is wrong and this will work as expected. üòÖ</p> <p>However it reveals a lack of design that I‚Äôve found in many modules. It looks cumbersome to introduce some very opinionated default behaviour like creating a whole file tree by default, rather than simply leaving the user specify the exact destination path.</p> <p>In many other modules, this ends up restricting the use cases so much that the user will have to craft the feature herself, making the playbook much more complicated.</p> <p>It happens very often to me.</p> <h2 id="tldr">TL;DR</h2> <ul> <li>Very easy to use and deploy : only SSH and Python is required on the target machine. This is the reason why I stick to it, still.</li> <li>Not universal, though : mainly runs on Linux (Windows modules are separate ones, so you need to craft roles that include the 2 logics : one for Linux and one for Windows) ; there are other devices (like network routers) addressed through specific modules but I haven‚Äôt tested</li> <li>There is a lot of existing modules in <em>galaxy</em>, but you usually don‚Äôt use them because you don‚Äôt trust the code to be safe or it‚Äôs not doing exactly what you need, or it‚Äôs not documented.</li> <li>It‚Äôs slow : playbooks can very quickly take dozen of minutes with only a dozen of roles. This is because, to get them clean &amp; evolutive, modules are quite independent of each others and run in sequence. The result is that plays are not globally optimized and ansible seems to execute each task one after the other, each time cumulating the time to transfer, unzip and prepare the code to the remote host‚Ä¶</li> <li>A LOT of modules don‚Äôt have a <em>check mode</em>, and ansible does not make it easy to provide one. So you will basically capitulate and don‚Äôt test fully your playbooks.</li> <li>I find many core features, modules, lookups, to have design flaws, making it sooo complex to do simple things‚Ä¶ Quite often I end up with a (not-so-portable) <code class="language-plaintext highlighter-rouge">command</code> instead of crafting 3-4 tasks together, that would have made the play undreadable.</li> </ul> <h2 id="also">Also</h2> <ul> <li>no way to declare a requirement inside a role (I have to use requirements.yml and install by hand with galaxy ?)</li> <li>cannot order in all parts (find the example ; was it with pre/post within roles ?)</li> <li> <p>it‚Äôs SLOW ! For instance looping on a list makes (apparently ?) ansible trigger one connection for each item ! For instance if you include the <em>haxorof.docker_ce</em> role in each role that needs docker installed, you just add several minutes to each one of them !</p> </li> <li> <p>Check mode was a good idea but since it‚Äôs only implemented in half of the modules it‚Äôs unuseable. The playbook will fail because a prerequisite will not be done by some previous task (e.g. set a fact, create a file, ‚Ä¶) or just return inconsistent results, making the test useless‚Ä¶ It may be useful to test a single task or small group of task but cannot be used to get confidence that a playbook will work. In order to change this, one would need to apply strict development rules (making sure every task has an (actually useful) check mode), but ansible does not make it easy by providing little to nothing to allow this. For instance, there is no simple way to provide an alternate command to the ‚Äòcommand‚Äô module, that would execute in check mode (it‚Äôs just one drop in the ocean, however).</p> </li> <li>globally counter-intuitive behaviors, which often lead to bugs or does not compile : <ul> <li>variables are global, and cannot be redefined in a role if already set, but it‚Äôs silent so you will not get the intended value ! -&gt; you need to prefix variables in roles with the name of the role (or maybe it‚Äôs the purpose of collections, but it came a bit late now I have to redesign all my roles‚Ä¶). See https://stackoverflow.com/questions/22522985/how-can-i-write-variables-inside-the-tasks-file-in-ansible =&gt; there is no simple way to cleanly define ‚Äòlocal‚Äô variables, which makes the ‚Äúcode‚Äù cluttered with copy-pasted texts and makes it less evolutive</li> <li>include_role and other similar ‚Äúmodules‚Äù don‚Äôt propagate their properties (e.g. ‚Äòignore_errors‚Äô), you have to use ‚Äòapply‚Äô or stick with import_role‚Ä¶</li> <li>cannot loop inside a loop (you have to put in an external file) ; it makes the code heavy</li> <li>cannot loop blocks‚Ä¶</li> <li>I‚Äôm not the only one : https://medium.com/opsops/ansible-anti-pattern-import-role-task-with-task-level-vars-a9f5c752c9c3</li> <li>they have so many issues (over 1k !) that I don‚Äôt see how they can possibly go through‚Ä¶ And it‚Äôs almost impossible to find one (try to search an issue for <code class="language-plaintext highlighter-rouge">is file</code> test on paths‚Ä¶)</li> </ul> </li> <li> <p>Le test minimum : avec -vv -C en ciblant un seul serveur pour aller plus vite puis seulement une fois toutes les erreurs de syntaxe corrig√©es lancer sur tous</p> </li> <li>diviser les t√¢ches par type de machine cible (ex. master / node) sinon cr√©er des r√¥les diff√©rents mais travail plus cons√©quent</li> </ul> <h2 id="references">References</h2> <ul> <li><a href="http://www.oznetnerd.com/use-ansible-tags-organise-plays-tasks/">Use Ansible Tags to Organise your Plays &amp; Tasks</a></li> </ul> <aside class="tags"> <ul class="tags"> <li class="tag"><a href="/tags#raspberry-pi">#raspberry pi</a></li> <li class="tag"><a href="/tags#bluetooth">#bluetooth</a></li> <li class="tag"><a href="/tags#series-your-own-cloud">#Series : your own cloud</a></li> </ul> </aside> <!--aside class="share"> <strong>Share this :</strong> <a href="http://twitter.com/share?text=Ansible : love and hate&amp;url=http://*:4000/2024/Playing-with-ansible&amp;hashtags=web,dev,blog,soudev&amp;via=" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://*:4000/2024/Playing-with-ansible" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside--> </div> </article> <div id="comment-section"></div> <script> initComments({ node: document.getElementById("comment-section"), defaultHomeserverUrl: "https://matrix.cactus.chat:8448", serverName: "cactus.chat", /* Chat room name will be the concatenation of 'comments_', siteName, '_', commentSectionId. E.g. #comments_nicolabs.net_LineageOS4microg-Upgrade:cactus.chat */ siteName: "nicolabs.net", /* Don't use page.url as slashes are not supported : https://gitlab.com/cactus-comments/cactus-client/-/issues/62 */ commentSectionId: "Playing-with-ansible" }) </script> <noscript>Please enable JavaScript to view the <a href="https://cactus.chat" rel="nofollow">comments powered by matrix.org.</a></noscript> <footer class="site-footer"> <div class="container"> <small class="pull-right">by <a rel="me" href="/about#contact">@nicobo</a></small> </div> </footer> </main> </body> </html>
